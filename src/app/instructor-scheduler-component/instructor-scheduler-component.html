<div class="page-header">
  <h1>Instructor Dashboard</h1>
  <button mat-raised-button color="primary" (click)="openCreateAppointmentDialog()">
    + Create Appointment Slot
  </button>
</div>

<div class="section-container">
  <div class="section-header">
    <h2 class="section-title">Available Slots</h2>
    <p class="section-subtitle">Appointment slots open for student booking</p>
  </div>

  <mat-accordion>
    <mat-expansion-panel hideToggle>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>groups</mat-icon>
          Group Slots
        </mat-panel-title>
        <mat-panel-description>
          {{ groupSlots.length }} slots available
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div *ngIf="groupSlotsLoading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading group slots...</p>
      </div>

      <div *ngIf="groupSlotsError" class="error-container">
        <p class="error-message">{{ groupSlotsError }}</p>
        <button mat-raised-button color="primary" (click)="loadGroupSlots()">
          Retry
        </button>
      </div>

      <div *ngIf="!groupSlotsLoading && !groupSlotsError && groupSlots.length === 0" class="no-data-container">
        <mat-icon>inbox</mat-icon>
        <p>No group slots created yet. Create a group slot for students to join.</p>
      </div>

      <div *ngIf="!groupSlotsLoading && !groupSlotsError && groupSlots.length > 0" class="instructors-row">
        <mat-card
          *ngFor="let slot of groupSlots"
          class="example-card available-card"
          appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>group</mat-icon>
              {{ slot.groupName || 'Group Slot' }}
            </mat-card-title>
            <mat-card-subtitle>
              Group ID: {{ slot.groupId }}
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <p>
              <strong>Max Members:</strong> {{ slot.maxMembers || 'N/A' }}<br>
              <strong>Created:</strong> {{ formatDate(slot.createdAt) }}<br>
              <strong>Status:</strong> <span class="status-badge available">AVAILABLE FOR STUDENTS</span>
            </p>
          </mat-card-content>

          <mat-card-actions>
            <button mat-raised-button color="warn" (click)="deleteGroupSlot(slot.groupId)">
              <mat-icon>delete</mat-icon>
              Delete Slot
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel hideToggle>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>person</mat-icon>
          Individual Appointments
        </mat-panel-title>
        <mat-panel-description>
          {{ individualAppointments.length }} slots available
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div *ngIf="individualLoading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading individual appointments...</p>
      </div>

      <div *ngIf="individualError" class="error-container">
        <p class="error-message">{{ individualError }}</p>
        <button mat-raised-button color="primary" (click)="loadIndividualAppointments()">
          Retry
        </button>
      </div>

      <div *ngIf="!individualLoading && !individualError && individualAppointments.length === 0" class="no-data-container">
        <mat-icon>inbox</mat-icon>
        <p>No individual appointment slots created yet.</p>
      </div>

      <div *ngIf="!individualLoading && !individualError && individualAppointments.length > 0" class="instructors-row">
        <mat-card 
          *ngFor="let appointment of individualAppointments" 
          class="example-card available-card" 
          appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>description</mat-icon>
              {{ appointment.description || 'Individual Appointment' }}
            </mat-card-title>
            <mat-card-subtitle>Slot ID: {{ appointment.appointmentId }}</mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <p>
              <strong>Date:</strong> {{ formatFullDate(appointment.appointmentDate) }}<br>
              <strong>Time:</strong> {{ formatTime(appointment.startTime) }} - {{ formatTime(appointment.endTime) }}<br>
              <strong>Location:</strong> {{ appointment.location || 'N/A' }}<br>
              <strong>Created:</strong> {{ formatDate(appointment.createdAt) }}<br>
              <strong>Status:</strong> <span class="status-badge available">OPEN FOR BOOKING</span>
            </p>
          </mat-card-content>
          
          <mat-card-actions>
            <button mat-raised-button color="warn" (click)="deleteIndividualAppointment(appointment.appointmentId)">
              <mat-icon>delete</mat-icon>
              Delete Slot
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel hideToggle>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>event</mat-icon>
          Group Appointments
        </mat-panel-title>
        <mat-panel-description>
          {{ groupAppointments.length }} appointments available
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div *ngIf="groupAppointmentsLoading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading group appointments...</p>
      </div>

      <div *ngIf="groupAppointmentsError" class="error-container">
        <p class="error-message">{{ groupAppointmentsError }}</p>
        <button mat-raised-button color="primary" (click)="loadGroupAppointments()">
          Retry
        </button>
      </div>

      <div *ngIf="!groupAppointmentsLoading && !groupAppointmentsError && groupAppointments.length === 0" class="no-data-container">
        <mat-icon>inbox</mat-icon>
        <p>No group appointments created yet.</p>
      </div>

      <div *ngIf="!groupAppointmentsLoading && !groupAppointmentsError && groupAppointments.length > 0" class="instructors-row">
        <mat-card
          *ngFor="let appointment of groupAppointments"
          class="example-card available-card"
          appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>event</mat-icon>
              Group Appointment - {{ formatDate(appointment.appointmentDate) }}
            </mat-card-title>
            <mat-card-subtitle>
              ID: {{ appointment.groupAppointmentId }}
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <p>
              <strong>Date:</strong> {{ formatDate(appointment.appointmentDate) }}<br>
              <strong>Time:</strong> {{ formatTime(appointment.startTime) }} - {{ formatTime(appointment.endTime) }}<br>
              <strong>Description:</strong> {{ appointment.description || 'No description' }}<br>
              <strong>Created:</strong> {{ formatDate(appointment.createdAt) }}<br>
              <strong>Status:</strong>
            </p>
          </mat-card-content>

          <mat-card-actions>
            <button mat-raised-button color="warn" (click)="deleteGroupAppointment(appointment.groupAppointmentId)">
              <mat-icon>delete</mat-icon>
              Delete Appointment
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</div>

<div class="section-container">
  <div class="section-header">
    <h2 class="section-title">Booked Appointments</h2>
    <p class="section-subtitle">Students who have booked your appointment slots</p>
  </div>

  <div *ngIf="bookedLoading" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading booked appointments...</p>
  </div>

  <div *ngIf="bookedError" class="error-container">
    <p class="error-message">{{ bookedError }}</p>
    <button mat-raised-button color="primary" (click)="loadBookedAppointments()">
      Retry
    </button>
  </div>

  <mat-accordion *ngIf="!bookedLoading && !bookedError">
    <mat-expansion-panel hideToggle>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>groups</mat-icon>
          Group Slot Bookings
        </mat-panel-title>
        <mat-panel-description>
          {{ bookedGroupAppointments.length }} slot is booked
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div *ngIf="bookedGroupAppointments.length === 0" class="no-data-container">
        <mat-icon>inbox</mat-icon>
        <p>No students have joined group slots yet.</p>
      </div>

      <div *ngIf="bookedGroupAppointments.length > 0" class="instructors-row">
        <mat-card 
          *ngFor="let booking of bookedGroupAppointments" 
          class="example-card booked-card" 
          appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>group</mat-icon>
              {{ booking.groupDetails?.groupName || 'Group Appointment' }}
            </mat-card-title>
            <mat-card-subtitle>
              Booked by: {{ getStudentName(booking) }}
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <p>
              <strong>Max Participants:</strong> {{ booking.groupDetails?.maxMembers || 'Unlimited' }}<br>
              <strong>Student Email:</strong> {{ getStudentEmail(booking) }}<br>
              <strong>Booked On:</strong> {{ formatDate(booking.bookedAt) }}<br>
              <strong>Status:</strong> <span class="status-badge booked">{{ booking.status.toUpperCase() }}</span>
            </p>

            <div *ngIf="booking.groupId" class="group-members-section">
              <button 
                mat-stroked-button 
                color="primary" 
                (click)="toggleGroupMembers(booking.groupId!)"
                class="show-members-btn">
                <mat-icon>{{ showingGroupMembers[booking.groupId!] ? 'expand_less' : 'expand_more' }}</mat-icon>
                {{ showingGroupMembers[booking.groupId!] ? 'Hide' : 'Show' }} Group Members
                <span *ngIf="groupMemberCounts[booking.groupId!]" class="member-count-badge">
                  ({{ groupMemberCounts[booking.groupId!] }})
                </span>
              </button>

              <div *ngIf="loadingGroupMembers[booking.groupId!]" class="loading-members">
                <mat-spinner diameter="30"></mat-spinner>
              </div>

              <div *ngIf="showingGroupMembers[booking.groupId!] && !loadingGroupMembers[booking.groupId!]" 
                   class="members-list">
                <ng-container *ngIf="groupMembers[booking.groupId!] && isArray(groupMembers[booking.groupId!]) && groupMembers[booking.groupId!].length > 0">
                  <div *ngFor="let member of groupMembers[booking.groupId!]; let i = index" class="member-item">
                    <span class="member-number">{{ i + 1 }}</span>
                    <mat-icon>person</mat-icon>
                    <span class="member-name">{{ member.memberFirstName }} {{ member.memberLastName }}</span>
                  </div>
                </ng-container>

                <div *ngIf="!groupMembers[booking.groupId!] || !isArray(groupMembers[booking.groupId!]) || groupMembers[booking.groupId!].length === 0" 
                     class="no-members">
                  <mat-icon>info</mat-icon>
                  <span>No members yet</span>
                </div>
              </div>
            </div>

          </mat-card-content>
        </mat-card>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel hideToggle>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>person</mat-icon>
          Individual Appointments
        </mat-panel-title>
        <mat-panel-description>
          {{ bookedIndividualAppointments.length }} booked
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div *ngIf="bookedIndividualAppointments.length === 0" class="no-data-container">
        <mat-icon>inbox</mat-icon>
        <p>No individual appointments booked yet.</p>
      </div>

      <div *ngIf="bookedIndividualAppointments.length > 0" class="instructors-row">
        <mat-card 
          *ngFor="let booking of bookedIndividualAppointments" 
          class="example-card booked-card" 
          appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>description</mat-icon>
              {{ booking.appointmentDetails?.description || 'Individual Appointment' }}
            </mat-card-title>
            <mat-card-subtitle>
              Student: {{ getStudentName(booking) }}
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <p>
              <strong>Date:</strong> {{ formatFullDate(booking.appointmentDetails?.appointmentDate) }}<br>
              <strong>Time:</strong> {{ formatTime(booking.appointmentDetails?.startTime) }} - {{ formatTime(booking.appointmentDetails?.endTime) }}<br>
              <strong>Location:</strong> {{ booking.appointmentDetails?.location || 'N/A' }}<br>
              <strong>Student Email:</strong> {{ getStudentEmail(booking) }}<br>
              <strong>Booked On:</strong> {{ formatDate(booking.bookedAt) }}<br>
              <strong>Status:</strong> <span class="status-badge booked">{{ booking.status.toUpperCase() }}</span>
            </p>
          </mat-card-content>
          
          <mat-card-actions>
            <button mat-button color="primary">
              <mat-icon>email</mat-icon>
              Contact Student
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</div>
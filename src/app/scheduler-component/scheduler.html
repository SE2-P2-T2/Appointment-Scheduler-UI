<div class="page-container">
  <div class="section">
    <div class="section-header">
      <div class="section-title">
        <mat-icon>school</mat-icon>
        <h2>Professor Selection</h2>
      </div>
      <p class="section-subtitle">Choose your instructor to view available appointment slots</p>
    </div>

    <div class="section-content">
      <div *ngIf="loadingInstructors" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading instructors...</p>
      </div>

      <div *ngIf="!loadingInstructors" class="cards-grid">
        <mat-card 
          *ngFor="let instructor of instructors"
          class="instructor-card" 
          [class.selected]="selectedInstructor?.userId === instructor.userId"
          appearance="outlined">
          <mat-card-header>
            <div mat-card-avatar class="instructor-avatar">
              <mat-icon>account_circle</mat-icon>
            </div>
            <mat-card-title>{{ getInstructorFullName(instructor) }}</mat-card-title>
            <mat-card-subtitle>{{ instructor.email }}</mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <p class="instructor-username">
              <mat-icon>alternate_email</mat-icon>
              <span>{{ instructor.username || 'N/A' }}</span>
            </p>
          </mat-card-content>
          
          <mat-card-actions>
            <button 
              mat-raised-button 
              [color]="selectedInstructor?.userId === instructor.userId ? 'accent' : 'primary'"
              (click)="selectInstructor(instructor)">
              <mat-icon>{{ selectedInstructor?.userId === instructor.userId ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
              {{ selectedInstructor?.userId === instructor.userId ? 'Selected' : 'Select' }}
            </button>
          </mat-card-actions>
        </mat-card>
      </div>

      <div *ngIf="!loadingInstructors && instructors.length === 0" class="no-data-container">
        <mat-icon>info</mat-icon>
        <p>No instructors available at the moment.</p>
      </div>
    </div>
  </div>

  <div class="section" *ngIf="selectedInstructor">
    <div class="section-header">
      <div class="section-title">
        <mat-icon>event_available</mat-icon>
        <h2>Appointment Availability</h2>
      </div>
      <p class="section-subtitle">
        Available slots for <strong>{{ getInstructorFullName(selectedInstructor) }}</strong>
      </p>
    </div>

    <div class="section-content">
      <div class="subsection">
        <div class="subsection-header">
          <mat-icon>person</mat-icon>
          <h3>Individual Appointments</h3>
          <span class="count-badge">{{ availableIndividualAppointments.length }}</span>
        </div>

        <div *ngIf="loadingIndividual" class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading appointments...</p>
        </div>

        <div *ngIf="!loadingIndividual && availableIndividualAppointments.length === 0" class="no-data-container">
          <mat-icon>event_busy</mat-icon>
          <p>No individual appointment slots available.</p>
        </div>

        <div *ngIf="!loadingIndividual && availableIndividualAppointments.length > 0" class="cards-grid">
          <mat-card 
            *ngFor="let appointment of availableIndividualAppointments"
            class="appointment-card available-card" 
            appearance="outlined">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>description</mat-icon>
                {{ appointment.description || 'Individual Appointment' }}
              </mat-card-title>
              <mat-card-subtitle>
                {{ formatFullDate(appointment.appointmentDate) }}
              </mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="appointment-details">
                <div class="detail-row">
                  <mat-icon>schedule</mat-icon>
                  <span>{{ formatTime(appointment.startTime) }} - {{ formatTime(appointment.endTime) }}</span>
                </div>
                <div class="detail-row">
                  <mat-icon>place</mat-icon>
                  <span>{{ appointment.location || 'Location TBD' }}</span>
                </div>
                <div class="detail-row">
                  <mat-icon>info</mat-icon>
                  <span class="status-badge available">AVAILABLE</span>
                </div>
              </div>
            </mat-card-content>
            
            <mat-card-actions>
              <button 
                mat-raised-button 
                color="primary"
                (click)="bookIndividualAppointment(appointment.appointmentId!, appointment.description || '')">
                <mat-icon>event_available</mat-icon>
                Book Appointment
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>

      <div class="subsection">
        <div class="subsection-header">
          <mat-icon>groups</mat-icon>
          <h3>Group Appointments</h3>
          <span class="count-badge">{{ availableGroupAppointments.length }}</span>
        </div>

        <div *ngIf="loadingGroup" class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading group appointments...</p>
        </div>

        <div *ngIf="!loadingGroup && availableGroupAppointments.length === 0" class="no-data-container">
          <mat-icon>event_busy</mat-icon>
          <p>No group appointment slots available.</p>
        </div>

        <div *ngIf="!loadingGroup && availableGroupAppointments.length > 0" class="cards-grid">
          <mat-card 
            *ngFor="let appointment of availableGroupAppointments"
            class="appointment-card available-card" 
            [class.full-card]="isGroupFull(appointment.groupId!)"
            appearance="outlined">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>group</mat-icon>
                {{ appointment.groupName || 'Group Appointment' }}
              </mat-card-title>
              <mat-card-subtitle>
                Group ID: {{ appointment.groupId }}
              </mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="appointment-details">
                <div class="detail-row">
                  <mat-icon>schedule</mat-icon>
                  <span>{{ formatTime(appointment.startTime) }} - {{ formatTime(appointment.endTime) }}</span>
                </div>
                
                <div class="detail-row capacity-row">
                  <mat-icon>people</mat-icon>
                  <span *ngIf="!loadingGroupCapacity[appointment.groupId!]">
                    <strong>Capacity:</strong> 
                    <span class="capacity-indicator" [class.full]="isGroupFull(appointment.groupId!)">
                      {{ groupMemberCounts[appointment.groupId!] || 0 }} / {{ appointment.maxLimit }}
                    </span>
                    <span class="capacity-badge" [class.full]="isGroupFull(appointment.groupId!)">
                      {{ isGroupFull(appointment.groupId!) ? 'FULL' : 'AVAILABLE' }}
                    </span>
                  </span>
                  <mat-spinner *ngIf="loadingGroupCapacity[appointment.groupId!]" diameter="20"></mat-spinner>
                </div>
                
                <div class="detail-row">
                  <mat-icon>description</mat-icon>
                  <span>{{ appointment.description || 'No description' }}</span>
                </div>
                <div class="detail-row">
                  <mat-icon>info</mat-icon>
                  <span class="status-badge" [class.full]="isGroupFull(appointment.groupId!)">
                    {{ isGroupFull(appointment.groupId!) ? 'FULL' : 'AVAILABLE' }}
                  </span>
                </div>
              </div>
            </mat-card-content>
            
            <mat-card-actions>
              <button 
                mat-raised-button 
                [color]="isGroupFull(appointment.groupId!) ? 'warn' : 'primary'"
                [disabled]="isGroupFull(appointment.groupId!)"
                (click)="bookGroupAppointment(appointment.groupId!, appointment.description || '')">
                <mat-icon>{{ isGroupFull(appointment.groupId!) ? 'block' : 'event_available' }}</mat-icon>
                {{ isGroupFull(appointment.groupId!) ? 'Group Full' : 'Join Group Slot' }}
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">
        <mat-icon>bookmark</mat-icon>
        <h2>My Booked Appointments</h2>
      </div>
      <p class="section-subtitle">Your confirmed and cancelled appointments</p>
    </div>

    <div class="section-content">
      <div *ngIf="loadingBookings" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading your bookings...</p>
      </div>

      <div *ngIf="!loadingBookings && myBookings.length === 0" class="no-data-container">
        <mat-icon>inbox</mat-icon>
        <p>You haven't booked any appointments yet.</p>
        <p class="hint-text">Select an instructor above to view available slots!</p>
      </div>

      <div *ngIf="!loadingBookings && myBookings.length > 0" class="cards-grid">
        <mat-card 
          *ngFor="let booking of myBookings"
          class="appointment-card booked-card"
          [class.cancelled-card]="booking.status === 'cancelled'"
          appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>{{ booking.bookingType === 'individual' ? 'person' : 'groups' }}</mat-icon>
              {{ booking.bookingType === 'individual' ? 'Individual' : 'Group' }} Appointment
            </mat-card-title>
            <mat-card-subtitle>
              Booking ID: #{{ booking.bookingId }}
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <div class="appointment-details">
              <div class="detail-row">
                <mat-icon>calendar_today</mat-icon>
                <span>Booked: {{ formatDate(booking.bookedAt) }}</span>
              </div>
              <div class="detail-row" *ngIf="booking.notes">
                <mat-icon>note</mat-icon>
                <span>{{ booking.notes }}</span>
              </div>
              <div class="detail-row">
                <mat-icon>info</mat-icon>
                <span class="status-badge" [ngClass]="getBookingStatusColor(booking.status)">
                  {{ booking.status.toUpperCase() }}
                </span>
              </div>
              <div class="detail-row" *ngIf="booking.status === 'cancelled' && booking.cancellationReason">
                <mat-icon>cancel</mat-icon>
                <span class="cancellation-reason">{{ booking.cancellationReason }}</span>
              </div>
            </div>


            <div *ngIf="booking.bookingType === 'group' && booking.groupId && booking.status === 'confirmed'" class="group-members-section">
              <button 
                mat-stroked-button 
                color="primary" 
                (click)="toggleMyGroupMembers(booking.groupId!)"
                class="show-members-btn">
                <mat-icon>{{ showingMyGroupMembers[booking.groupId!] ? 'expand_less' : 'expand_more' }}</mat-icon>
                {{ showingMyGroupMembers[booking.groupId!] ? 'Hide' : 'Show' }} Group Members
              </button>

              <div *ngIf="loadingMyGroupMembers[booking.groupId!]" class="loading-members">
                <mat-spinner diameter="30"></mat-spinner>
              </div>

              <div *ngIf="showingMyGroupMembers[booking.groupId!] && !loadingMyGroupMembers[booking.groupId!]" 
                   class="members-list">
                <ng-container *ngIf="myGroupMembers[booking.groupId!] && isArray(myGroupMembers[booking.groupId!]) && myGroupMembers[booking.groupId!].length > 0">
                  <div class="members-header">
                    <mat-icon>people</mat-icon>
                    <span>Group Members ({{ myGroupMembers[booking.groupId!].length }})</span>
                  </div>
                  <div *ngFor="let member of myGroupMembers[booking.groupId!]; let i = index" class="member-item">
                    <span class="member-number">{{ i + 1 }}</span>
                    <mat-icon>person</mat-icon>
                    <span class="member-name">{{ member.memberFirstName }} {{ member.memberLastName }}</span>
                  </div>
                </ng-container>
                
                <div *ngIf="!myGroupMembers[booking.groupId!] || !isArray(myGroupMembers[booking.groupId!]) || myGroupMembers[booking.groupId!].length === 0" 
                     class="no-members">
                  <mat-icon>info</mat-icon>
                  <span>No other members yet</span>
                </div>
              </div>
            </div>

          </mat-card-content>
          
          <mat-card-actions>
            <button 
              mat-button 
              color="warn"
              *ngIf="booking.status === 'confirmed' && booking.bookingType === 'individual'"
              (click)="cancelBooking(booking.bookingId!)">
              <mat-icon>cancel</mat-icon>
              Cancel Booking
            </button>
            <button 
              mat-button 
              color="warn"
              *ngIf="booking.status === 'confirmed' && booking.bookingType === 'group'"
              (click)="cancelGroupBooking(booking.bookingId!, booking.groupId!)">
              <mat-icon>cancel</mat-icon>
              Cancel for All Members
            </button>
            <button 
              mat-button 
              disabled
              *ngIf="booking.status === 'cancelled'">
              <mat-icon>block</mat-icon>
              Cancelled
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>
  </div>

</div>